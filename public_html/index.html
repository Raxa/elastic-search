<!DOCTYPE html>
<html>
    <head>
        <title> simple db searching </title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script type="text/javascript" src="jquery-1.9.1.min.js"></script>
    </head>
    <body>
        <script>
            // body.onload
            function checkAuth() {
                if (getCookie('authorized') === 'true') {
                    $('#auth').css("display","none");
                    $('#session_info').css("display","block");
                }
                else {
                    $('#auth').css("display","block");
                    $('#session_info').css("display","none");
                }
            }
            function createCookie(name, value, ms) {
                var expires;
                if (ms) {
                    var date = new Date();
                    date.setTime(date.getTime() + ms);
                    expires = "; expires=" + date.toGMTString();
                }
                else expires = "";
                document.cookie = name + "=" + value + expires + "; path=/";
            }
            
            function getCookie(c_name) {
                if (document.cookie.length > 0) {
                    c_start = document.cookie.indexOf(c_name + "=");
                        if (c_start != -1) {
                            c_start = c_start + c_name.length + 1;
                            c_end = document.cookie.indexOf(";", c_start);
                            if (c_end == -1) {
                                c_end = document.cookie.length;
                            }
                            return unescape(document.cookie.substring(c_start, c_end));
                        }
                }
                return "";
            }
            
            function auth() {
                var username = $('#login').val();
                var password = $('#pass').val();
                var method = 'GET';
                var url = 'http://localhost:8080/openmrs/ws/rest/v1/session';
                var req = new XMLHttpRequest();
                if('withCredentials' in req) {
                        req.open(method, url, true);
                        req.setRequestHeader("Authorization", "Basic " + window.btoa(username + ":" + password));
                        req.onreadystatechange = function() {
                            if ((req.readyState === 4) && (req.status >= 200) && (req.status < 400)) {
                                var data = JSON.parse(req.responseText);
                                if (data.authenticated) {
                                    createCookie('jsessionid',data.sessionid,600*1000);
                                    createCookie('authorized',true,600*1000);
                                    checkAuth();
                                }
                            }
                        };
                        req.send();
                }
            }

            function search() {
                    var data = $('#serch-value').val();
                    var json = {};
                    json.type = "plain";
                    json.data = data;
                    $.ajax({
                        datatype: 'JSON',
                        type: 'POST',
                        url: 'http://localhost:1024',
                        data: JSON.stringify(json),
                        success: function(result) {
                            $('#serch-results').text('');
                            var rslt = JSON.parse(result);
                            if (rslt.hits.total === 0) $('#serch-results').text("Nothing found");
                            else for (var i=0;i<rslt.hits.total;i++) {
                                if (rslt.hits.hits[i]) {
                                    $('#serch-results').append(rslt.hits.hits[i]._source.given_name);
                                    $('#serch-results').append(" ");
                                    $('#serch-results').append(rslt.hits.hits[i]._source.family_name);
                                    $('#serch-results').append('<br/>');
                                }
                            }
                            $('#serch-results').append(rslt);
                        }
                    });
            }
        </script>
        Search for values in table "person_name" by "given_name"
        <br/>
        <input type="text" id="serch-value">
        <input type="button" onclick="search();" value="Search">
        <div id="serch-results">
            &nbsp;
        </div>
    </body>
</html>
